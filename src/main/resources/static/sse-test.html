<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>SSE / API Test Console (Fixed)</title>
    <style>
        body {
            font-family: monospace;
            padding: 12px;
        }
        select, input, textarea, button {
            width: 100%;
            margin-bottom: 6px;
            font-family: monospace;
        }
        textarea {
            height: 120px;
        }
        button {
            margin-top: 6px;
        }
        pre {
            background: #111;
            color: #0f0;
            padding: 10px;
            height: 350px;
            overflow: auto;
        }
    </style>
</head>
<body>

<h2>SSE / API Test Console</h2>

<label>HTTP Method</label>
<select id="method">
    <option>GET</option>
    <option>POST</option>
    <option>PUT</option>
    <option>DELETE</option>
</select>

<label>API URL</label>
<input id="url" value="/api/statistics/object/internalnetwork/table" />

<label>Request Body (JSON ‚Üí Query for SSE)</label>
<textarea id="body">
{
  "limit": 10,
  "startDate": "202509130000",
  "endDate": "202509140000",
  "scale": "5min"
}
</textarea>

<button onclick="send()">Send</button>
<button onclick="disconnect()">Disconnect</button>
<button onclick="clearLog()">Clear</button>

<pre id="log"></pre>

<script>
    let es = null;
    let refreshKey = 0;

    function log(msg) {
        const el = document.getElementById("log");
        el.textContent += msg + "\n";
        el.scrollTop = el.scrollHeight;
    }

    function clearLog() {
        document.getElementById("log").textContent = "";
    }

    function disconnect() {
        if (es) {
            es.close();
            es = null;
            log("‚èπ SSE disconnected");
        }
    }

    function buildSseUrl(baseUrl, body) {
        const params = new URLSearchParams(body || {});
        params.append("_refresh", ++refreshKey);
        return `${baseUrl}?${params.toString()}`;
    }

    function send() {
        disconnect();

        const method = document.getElementById("method").value;
        const baseUrl = document.getElementById("url").value.trim();
        const bodyText = document.getElementById("body").value.trim();

        let body;
        try {
            body = bodyText ? JSON.parse(bodyText) : {};
        } catch {
            alert("Invalid JSON body");
            return;
        }

        log(`‚ñ∂ ${method} ${baseUrl}`);

        /* ======================
           SSE (GET only)
        ====================== */
        if (method === "GET") {
            const sseUrl = buildSseUrl(baseUrl, body);
            log(`‚ñ∂ SSE CONNECT ${sseUrl}`);

            es = new EventSource(sseUrl);

            es.addEventListener("connect", e => {
                log("üîó connect: " + (e.data || ""));
            });

            // ÏÑúÎ≤ÑÏóêÏÑú Î≥¥ÎÇ∏ Ïã§Ï†ú Ïù¥Î≤§Ìä∏ Ïù¥Î¶ÑÍ≥º ÏùºÏπòÏãúÌÇµÎãàÎã§.
            es.addEventListener("ÌòÑÏû¨ Î°úÎî©Ïú®", e => {
                log("‚è≥ ÌòÑÏû¨ Î°úÎî©Ïú®: " + e.data);
            });

            es.addEventListener("Í≤∞Í≥ºÍ∞í", e => {
                log("‚úÖ Í≤∞Í≥ºÍ∞í ÏàòÏã†");
                try {
                    log(JSON.stringify(JSON.parse(e.data), null, 2));
                } catch {
                    log(e.data);
                }
                // ÌïÑÏöîÌïòÎ©¥ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú Ïó∞Í≤∞ÏùÑ Îã´ÏäµÎãàÎã§.
                es.close();
                es = null;
                log("‚èπ SSE closed by client");
            });

            // ÏÑúÎ≤ÑÏóêÏÑú Î≥¥ÎÇ∏ 'error'ÎùºÎäî Ïù¥Î¶ÑÏùò Ïù¥Î≤§Ìä∏(payload)Î•º Î≥ÑÎèÑÎ°ú Ï≤òÎ¶¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.
            es.addEventListener("error", e => {
                // Ïù¥ Ìï∏Îì§Îü¨Îäî ÏÑúÎ≤ÑÍ∞Ä ÏùòÎèÑÏ†ÅÏúºÎ°ú Î≥¥ÎÇ∏ 'error'ÎùºÎäî named eventÏôÄ
                // ÎÑ§Ìä∏ÏõåÌÅ¨/Ïª§ÎÑ•ÏÖò ÏóêÎü¨(onerror) Ïù¥Î≤§Ìä∏ Î™®ÎëêÏóê Í±∏Î¶¥ Ïàò ÏûàÏúºÎãà,
                // e.dataÍ∞Ä ÏûàÏúºÎ©¥ ÏÑúÎ≤ÑÍ∞Ä Î≥¥ÎÇ∏ ÏóêÎü¨ Î©îÏãúÏßÄÎ°ú Í∞ÑÏ£ºÌï©ÎãàÎã§.
                if (e && e.data) log("üö® server error event: " + e.data);
            });

            // onerrorÎäî Ïó∞Í≤∞Ïù¥ Îã´ÌûàÍ±∞ÎÇò ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏùÑ ÎïåÎèÑ Ìò∏Ï∂úÎê©ÎãàÎã§.
            es.onerror = (ev) => {
                if (es && es.readyState === EventSource.CLOSED) {
                    log("‚èπ SSE closed by server");
                } else {
                    log("‚ö†Ô∏è SSE error (server closed or network issue)");
                }
            };

            return;
        }

        /* ======================
           REST (non-SSE)
        ====================== */
        fetch(baseUrl, {
            method,
            headers: {
                "Content-Type": "application/json"
            },
            body: Object.keys(body).length ? JSON.stringify(body) : null
        })
            .then(res => res.text())
            .then(text => {
                try {
                    log(JSON.stringify(JSON.parse(text), null, 2));
                } catch {
                    log(text);
                }
            })
            .catch(err => log("‚ùå " + err));
    }
</script>

</body>
</html>
